{% extends "base.html" %}

{% block title %}API Keys - AgenticOCR{% endblock %}

{% block content %}
<div class="page-header">
    <h1>API Keys</h1>
    <p>Manage your API keys for programmatic access</p>

    <div class="page-actions">
        <button class="btn btn-primary" onclick="openModal('createKeyModal')">
            <span>‚ûï</span>
            Create API Key
        </button>
    </div>
</div>

<!-- API Keys List -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Your API Keys</div>
        <input type="text" class="form-control" placeholder="Search keys..." id="searchKeys" style="max-width: 300px;">
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table" id="keysTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Key Prefix</th>
                        <th>Last Used</th>
                        <th>Created</th>
                        <th>Expires</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="apiKeysList">
                    <tr>
                        <td colspan="7" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Usage Guide -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Usage Guide</div>
    </div>
    <div class="card-body">
        <h4 style="margin-bottom: 12px;">Authentication</h4>
        <p style="color: var(--gray-600); margin-bottom: 16px;">
            Include your API key in the Authorization header of all requests:
        </p>

        <div class="code-block">
            <button class="copy-btn" onclick="agenticOCR.copyToClipboard('curl -X POST {{ url_for(\'home\') }}api/v1/process/invoice \\\n  -H \'Authorization: Bearer YOUR_API_KEY\' \\\n  -F \'file=@invoice.pdf\'')">Copy</button>
            <pre>curl -X POST {{ url_for('home') }}api/v1/process/invoice \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -F "file=@invoice.pdf"</pre>
        </div>

        <h4 style="margin: 24px 0 12px;">Python Example</h4>
        <div class="code-block">
            <button class="copy-btn" onclick="agenticOCR.copyToClipboard(`import requests\n\napi_key = 'YOUR_API_KEY'\nheaders = {'Authorization': f'Bearer {api_key}'}\n\nwith open('invoice.pdf', 'rb') as f:\n    response = requests.post(\n        '{{ url_for('home') }}api/v1/process/invoice',\n        headers=headers,\n        files={'file': f}\n    )\n\nresult = response.json()\nprint(result['extracted_data'])`)">Copy</button>
            <pre>import requests

api_key = "YOUR_API_KEY"
headers = {"Authorization": f"Bearer {api_key}"}

with open("invoice.pdf", "rb") as f:
    response = requests.post(
        "{{ url_for('home') }}api/v1/process/invoice",
        headers=headers,
        files={"file": f}
    )

result = response.json()
print(result["extracted_data"])</pre>
        </div>

        <div class="alert alert-info" style="margin-top: 20px;">
            <strong>‚ÑπÔ∏è Security Tips:</strong>
            <ul style="margin: 8px 0 0 20px;">
                <li>Never share your API keys publicly or commit them to version control</li>
                <li>Use environment variables to store API keys in your applications</li>
                <li>Rotate keys regularly for enhanced security</li>
                <li>Set expiration dates to limit key lifetime</li>
            </ul>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal" id="createKeyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Create API Key</h3>
            <button class="modal-close" onclick="closeModal('createKeyModal')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="createKeyForm">
                <div class="form-group">
                    <label class="form-label">Key Name</label>
                    <input type="text" class="form-control" name="name" placeholder="Production API Key" required>
                    <small style="color: var(--gray-600);">A descriptive name for this key</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Expires In (days)</label>
                    <select class="form-control form-select" name="expires_in_days">
                        <option value="">Never</option>
                        <option value="30">30 days</option>
                        <option value="90">90 days</option>
                        <option value="180">180 days</option>
                        <option value="365" selected>365 days (1 year)</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createKeyModal')">Cancel</button>
            <button class="btn btn-primary" id="createKeyBtn" onclick="createAPIKey()">Create Key</button>
        </div>
    </div>
</div>

<!-- Show API Key Modal -->
<div class="modal" id="showKeyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">‚úì API Key Created</h3>
            <button class="modal-close" onclick="closeModal('showKeyModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-success">
                <strong>‚ö†Ô∏è Important:</strong> Make sure to copy your API key now. You won't be able to see it again!
            </div>

            <div class="form-group">
                <label class="form-label">Your API Key</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-control" id="newApiKey" readonly>
                    <button class="btn btn-secondary" onclick="copyNewKey()">Copy</button>
                </div>
            </div>

            <div class="code-block" style="margin-top: 20px;">
                <pre id="keyUsageExample"></pre>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('showKeyModal'); loadAPIKeys();">Done</button>
        </div>
    </div>
</div>

<script>
// Load API keys
async function loadAPIKeys() {
    try {
        const keys = await agenticOCR.apiRequest('/api/v1/auth/api-keys');

        const tbody = document.getElementById('apiKeysList');

        if (keys && keys.length > 0) {
            tbody.innerHTML = keys.map(key => `
                <tr>
                    <td><strong>${key.name}</strong></td>
                    <td><code>${key.key_prefix}...</code></td>
                    <td>${key.last_used ? agenticOCR.formatDate(key.last_used) : 'Never'}</td>
                    <td>${agenticOCR.formatDate(key.created_at)}</td>
                    <td>${key.expires_at ? agenticOCR.formatDate(key.expires_at) : 'Never'}</td>
                    <td>
                        <span class="badge badge-${key.is_active ? 'success' : 'danger'}">
                            ${key.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="revokeAPIKey('${key.id}', '${key.name}')">
                            Revoke
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîë</div>
                            <h3>No API keys yet</h3>
                            <p>Create your first API key to get started</p>
                            <button class="btn btn-primary" onclick="openModal('createKeyModal')">
                                Create API Key
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Setup search
        agenticOCR.setupSearchFilter('searchKeys', 'keysTable', [0, 1]);
    } catch (error) {
        console.error('Failed to load API keys:', error);
        agenticOCR.showToast('Failed to load API keys', 'danger');
    }
}

// Create API key
async function createAPIKey() {
    const form = document.getElementById('createKeyForm');

    if (!agenticOCR.validateForm(form)) {
        agenticOCR.showToast('Please fill in all required fields', 'danger');
        return;
    }

    const formData = new FormData(form);
    const data = {
        name: formData.get('name'),
        expires_in_days: formData.get('expires_in_days') ? parseInt(formData.get('expires_in_days')) : null,
    };

    const btn = document.getElementById('createKeyBtn');
    const originalText = btn.innerHTML;
    agenticOCR.showLoading(btn);

    try {
        const result = await agenticOCR.apiRequest('/api/v1/auth/api-keys', {
            method: 'POST',
            body: data,
        });

        if (result) {
            // Show the new key
            document.getElementById('newApiKey').value = result.key;
            document.getElementById('keyUsageExample').textContent =
                `curl -X POST ${window.location.origin}/api/v1/process/invoice \\
  -H "Authorization: Bearer ${result.key}" \\
  -F "file=@document.pdf"`;

            closeModal('createKeyModal');
            openModal('showKeyModal');

            form.reset();
            agenticOCR.showToast('API key created successfully!', 'success');
        }
    } catch (error) {
        agenticOCR.showToast(error.message, 'danger');
    } finally {
        agenticOCR.hideLoading(btn, originalText);
    }
}

// Copy new API key
function copyNewKey() {
    const keyInput = document.getElementById('newApiKey');
    agenticOCR.copyToClipboard(keyInput.value);
}

// Revoke API key
async function revokeAPIKey(keyId, keyName) {
    if (!confirm(`Are you sure you want to revoke "${keyName}"? This action cannot be undone.`)) {
        return;
    }

    try {
        await agenticOCR.apiRequest(`/api/v1/auth/api-keys/${keyId}`, {
            method: 'DELETE',
        });

        agenticOCR.showToast('API key revoked successfully', 'success');
        loadAPIKeys();
    } catch (error) {
        agenticOCR.showToast(error.message, 'danger');
    }
}

// Load keys on page load
document.addEventListener('DOMContentLoaded', loadAPIKeys);
</script>
{% endblock %}
